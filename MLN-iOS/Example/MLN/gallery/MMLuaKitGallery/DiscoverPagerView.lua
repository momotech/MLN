---
--- Generated by MLN Team (http://www.immomo.com)
--- Created by MLN Team.
--- DateTime: 2019-09-05 12:05
---

local _class = {
    _name = 'DiscoverPagerView',
    _version = '1.0'
}

---@public
function _class:new()
    local o = {}
    setmetatable(o, { __index = self })
    self.dataList = Array()
    self.requestPageIndex = 1
    return o
end

---@public
function _class:rootView()
    if self.containerView then
        return self.containerView
    end
    self:createSubviews()
    self:setupDataSource()
    return self.containerView
end

---ÂàõÂª∫Â≠êËßÜÂõæ
---@private
function _class:createSubviews()
    self:setupContainerView()
    self:setupTabSegmentView()
    self:setupCollectionView()
    self:setupSearchBox()
end

---ÂàõÂª∫ÂÆπÂô®ËßÜÂõæ
---@private
function _class:setupContainerView()
    self.containerView = LinearLayout(LinearType.VERTICAL)
            :width(MeasurementType.MATCH_PARENT):height(MeasurementType.MATCH_PARENT)
end

---ÂàõÂª∫ÂØºËà™Ê†è
---@private
function _class:setupTabSegmentView()
    --ÂØºËà™Ê†è
    self.navigation = require("MMLuaKitGallery.NavigationBar"):new()
    self.navibar = self.navigation:bar("ÂèëÁé∞", nil)
    self.containerView:addView(self.navibar)

    --Á≠æÂà∞
    self.signin = Label()
    self.signin:width(60):height(25):setGravity(MBit:bor(Gravity.RIGHT, Gravity.CENTER_VERTICAL)):marginRight(10)
    self.signin:bgColor(Color(204, 137, 24))--ok
        :cornerRadius(self.signin:height() / 2)
    self.signin:text("Á≠æÂà∞"):textAlign(TextAlign.CENTER):fontSize(11):textColor(_Color.White)
    self.signin:onClick(function()
        if self.signin:text() == "Á≠æÂà∞" then
            self.signin:text("Â∑≤Á≠æÂà∞")
        else
            self.signin:text("Á≠æÂà∞")
        end
    end)
    self.navibar:addView(self.signin)
end

---ÂàõÂª∫collectionView
---@private
function _class:setupCollectionView()
    self.headerViewHeight = 420

    self.collectionView = WaterfallView(true, true):width(MeasurementType.MATCH_PARENT):height(MeasurementType.MATCH_PARENT)
    self.collectionView:useAllSpanForLoading(true)
    self.collectionView:showScrollIndicator(true)
    self.containerView:addView(self.collectionView)

    self.layout = WaterfallLayoutFix()
    --self.layout:lineSpacing(30)
    self.layout:lineSpacing(0)
        :itemSpacing(10)
        :spanCount(2)
        :layoutInset(0, 10, 0, 10)
    self.collectionView:layout(self.layout)

    self:setupCollectionViewAdapter()
end

--- @private
function _class:setupCollectionViewAdapter()
    local cellReuseId = "cellReuseId"
    local cellWidth = (window:width() - 30) / 2
    local adapter = WaterfallAdapter()
    self.adapter = adapter

    adapter:headerValid(function(_)
        return true
    end)

    adapter:heightForHeader(function(_)
        return self.headerViewHeight
    end)

    adapter:initHeader(function(header)
        header.contentView:removeAllSubviews()
        header.contentView:addView(self:headerView())
    end)

    adapter:fillHeaderData(function(_, _, _)
        --do nothing
    end)

    adapter:sectionCount(function()
        return 1
    end)

    adapter:rowCount(function(_)
        return self.dataList:size()
    end)

    adapter:reuseId(function(_, _)
        return cellReuseId
    end)

    adapter:initCellByReuseId(cellReuseId, function(cell)
        local internalCell = require("MMLuaKitGallery.DiscoverCell"):new()
        internalCell:setupCellSubviews(cellWidth)
        cell._cell = internalCell
        cell.contentView:addView(internalCell.baseLayout)
    end)

    adapter:fillCellDataByReuseId(cellReuseId, function(cell, _, row)
        local item = self.dataList:get(row)
        local rank = item:get("rank") or 0
        cell._cell.imageView:image(item:get("album_500_500"))
        cell._cell.titleLabel:text(item:get("title"))
        cell._cell.countLabel:text(string.format("%sÁØá", rank + 1))
        cell._cell.lookLabel:text(string.format("%d", item:get("file_duration")))

        if rank and tonumber(rank) < 2 then
            cell._cell:updateContentIcons(nil)
        else
            cell._cell:updateContentCountText(rank)
            cell._cell:updateContentIcons(item:get("pic_small"))
        end
    end)

    adapter:heightForCell(function(_, row)
        local item = self.dataList:get(row)
        local rank = item:get("rank") or 0
        if rank and tonumber(rank) < 2 then
            return cellWidth + 75
        end
        return cellWidth + 90

    end)
    adapter:selectedRowByReuseId(cellReuseId, function(cell, _, row)
        --Toast(self.dataList:get(row):get("title"), 1)
        --self:gotoDetailView()
        if System:Android() then
            Navigator:gotoPage("file://android_asset/MMLuaKitGallery/IdeaMassView.lua",Map(),1)
        else
            Navigator:gotoPage("file://MMLuaKitGallery/IdeaMassView.lua",Map(),1)
        end
    end)
    self.collectionView:adapter(adapter)
end

---Êï∞ÊçÆÊ∫ê
---@private
function _class:setupDataSource()
    --È¶ñÂÖàÂ±ïÁ§∫Á¨¨‰∏ÄÈ°µÊï∞ÊçÆ
    self:requestNetwork(true, function(success, _)
        if success then
            self.collectionView:reloadData()
        end
    end)

    --‰∏ãÊãâÂà∑Êñ∞
    self.collectionView:setRefreshingCallback(function()
        self:requestNetwork(true, function(success, _)
            self.collectionView:stopRefreshing()
            self.collectionView:resetLoading()
            if success then
                self.collectionView:reloadData()
            end
        end)
    end)

    --‰∏äÊãâÂä†ËΩΩ
    self.collectionView:setLoadingCallback(function()
        self:requestNetwork(false, function(success, data)
            self.collectionView:stopLoading()
            if not data then
                self.collectionView:noMoreData()
            end
            if success then
                self.collectionView:reloadData()
            end
        end)
    end)
end

---ËØ∑Ê±ÇÊé•Âè£
---@private
function _class:requestNetwork(first, complete)
    if first then
        local pageIndexs = { 13, 9, 11, 12, 6 }
        local index = math.random(0, 6)
        self.requestPageIndex = pageIndexs[index] --ÈöèÊú∫‰∏Ä‰∏™indexËØ∑Ê±Ç‰∏çÂêåÁöÑÊï∞ÊçÆ
    else
        self.requestPageIndex = self.requestPageIndex + 1
    end

    if System:Android() then

        File:asyncReadMapFile('file://android_asset/MMLuaKitGallery/discoverry.json', function(codeNumber, response)

            print("codeNumber: " .. tostring(codeNumber))

            if codeNumber == 0 then
                local data = response:get("result")
                if first then
                    self.dataList = data
                elseif data then
                    self.dataList:addAll(data)
                end
                complete(true, self.dataList)
            else
                --error(err:get("errmsg"))
                complete(false, nil)
            end
        end)

        return
    end

    local HTTPHandler = require("MMLuaKitGallery.HTTPHandler")
    HTTPHandler:GET("https://api.apiopen.top/musicRankingsDetails", { type = self.requestPageIndex }, function(success, response, err)
        if success then
            local data = response:get("result")
            if first then
                self.dataList = data
            elseif data then
                self.dataList:addAll(data)
            end
            complete(success, data)
        else
            error(err:get("errmsg"))
            complete(false, nil)
        end
    end)
end

---ÂàõÂª∫ÊêúÁ¥¢Ê°Ü
---@private
function _class:setupSearchBox()
    local search = require("MMLuaKitGallery.SearchBox"):new()
    self.searchBar = search:setup(nil)
    return self.searchBar
end

---ÂàõÂª∫headerView
---@private
function _class:headerView()
    local width = self.collectionView:width() - 20
    self.headerView = View():width(width):height(self.headerViewHeight)

    --Á∫øÊÄßÂ∏ÉÂ±Ä
    self.headerViewLayout = LinearLayout(LinearType.VERTICAL):width(MeasurementType.WRAP_CONTENT):height(MeasurementType.WRAP_CONTENT)
    self.headerView:addView(self.headerViewLayout)

    --ÊêúÁ¥¢Ê°Ü
    local searchBar = self:setupSearchBox()
    self.headerViewLayout:addView(searchBar)

    --‰ΩøÁî®ÊåáÂçó
    self.guideImageView = ImageView():marginTop(10):width(width):height(MeasurementType.WRAP_CONTENT)
    self.guideImageView:addCornerMask(5, _Color.White, RectCorner.ALL_CORNERS)
    self.guideImageView:image('https://s.momocdn.com/w/u/others/2019/08/27/1566877265808-meilishuoguide.png')
    self.guideImageView:onClick(function()
        ---Âä†ËΩΩwebview http://act.meilishuo.com/wap/0118huya?acm=3.mce.2_10_1lpd6.130069.0.j5klrrAfO3TFd.pos_0-m_506297-sd_119
        Toast("ËØ∑Êü•ÁúãËØ∑‰ΩøÁî®ÊåáÂçó", 1)
    end)
    self.headerViewLayout:addView(self.guideImageView)

    --Á¶èÂà©Á§æ
    self.welfareImageView = ImageView():marginTop(10):width(width):height(MeasurementType.WRAP_CONTENT)
    self.welfareImageView:addCornerMask(5, _Color.White, RectCorner.ALL_CORNERS)
    self.welfareImageView:image("https://s.momocdn.com/w/u/others/2019/08/27/1566877691900-welfare.png")
    self.welfareImageView:onClick(function()
        Toast("Áõ¥Êé•ÂéªÁ¶èÂà©Á§æÊç¢ÂèñÁ¶èÂà©Âì¶", 1)
    end)
    self.headerViewLayout:addView(self.welfareImageView)

    --Êó•Â∏∏‰ªªÂä°ÂíåÂéªÁÇπËµûÂ∏ÉÂ±Ä
    self.dailyLayoutView = View():width(width):height(MeasurementType.WRAP_CONTENT):marginTop(5)
    self.headerViewLayout:addView(self.dailyLayoutView)

    --Êó•Â∏∏‰ªªÂä°
    local text = StyleString("Êó•Â∏∏‰ªªÂä°ÔºöÁÇπ‰∫ÆÁà±ÂøÉÔºå‰∏∫ÂÜÖÂÆπÁÇπËµû")
    text:fontSize(12):fontColor(_Color.DeepGray)
    text:setFontColorForRange(_Color.Black, 1, 5):setFontStyleForRange(FontStyle.BOLD, 1, 5)
    self.dailyTaskLabel = Label():setGravity(Gravity.CENTER_VERTICAL):styleText(text)
    self.dailyLayoutView:addView(self.dailyTaskLabel)

    --ÂéªÁÇπËµû
    self.likeButton = Label():width(54):height(18):setGravity(MBit:bor(Gravity.RIGHT, Gravity.CENTER_VERTICAL))
    self.likeButton:cornerRadius(self.likeButton:height() / 2):borderWidth(0.5):borderColor(Color(204, 137, 24))
    self.likeButton:text("ÂéªÁÇπËµû"):fontSize(10):textColor(Color(204, 137, 24)):textAlign(TextAlign.CENTER)
    self.likeButton:onClick(function()
        if self.likeButton:text() == "ÂéªÁÇπËµû" then
            self.likeButton:text("Â∑≤Ëµûüëç")
        else
            self.likeButton:text("ÂéªÁÇπËµû")
        end
    end)
    self.dailyLayoutView:addView(self.likeButton)

    --ÂàÜÂâ≤Á∫ø
    self.line = View():marginTop(10):width(width):height(0.5)
    self.line:bgColor(Color(230, 230, 230, 1))--ok
    self.headerViewLayout:addView(self.line)

    --ÁÅµÊÑüÈõÜ
    local text = StyleString("ÁÅµÊÑüÈõÜ / Êé¢Á¥¢Êõ¥ÊúâË∂£ÁöÑÊó∂È´¶ÁîüÊ¥ª")
    text:fontSize(13):fontColor(_Color.MediumGray)
    text:setFontSizeForRange(20, 1, 5)
    text:setFontColorForRange(_Color.Black, 1, 4):setFontStyleForRange(FontStyle.BOLD, 1, 4)
    self.descLabel = Label():width(MeasurementType.WRAP_CONTENT):height(50)
    self.descLabel:styleText(text)
    self.headerViewLayout:addView(self.descLabel)

    --Á∫øÊÄßÂ∏ÉÂ±ÄÂàÜÁ±ªÊåâÈíÆ
    local buttonLayout = LinearLayout(LinearType.HORIZONTAL)
    buttonLayout:width(width):setGravity(Gravity.BOTTOM):marginBottom(5)
    self.buttonLayout = buttonLayout
    self.headerView:addView(buttonLayout)

    self.categButtons = {}
    local titles = { "Êé®Ëçê", "Á©øÊê≠", "ÁæéÂ¶Ü", "Êé¢Â∫ó", "ÊóÖË°å" }
    for i = 1, #titles do
        local button = Label()
        local offset = i > 1 and 10 or 0
        button:marginLeft(offset):width(38):height(25):cornerRadius(12)
        button:bgColor(_Color.LightGray)--ok
        button:text(titles[i]):fontSize(12):textColor(_Color.Gray):textAlign(TextAlign.CENTER)
        button:onClick(function()
            self:clickCategoryButton(button)
        end)
        buttonLayout:addView(button)
        table.insert(self.categButtons, button)
    end
    self:updateCategoryButtonUI(self.categButtons[1])

    return self.headerView
end

---@private
function _class:clickCategoryButton(button)
    self:updateCategoryButtonUI(button)
    self:requestNetwork(true, function(success, _)
        if success == true then
            self.collectionView:reloadData()
        end
    end)
end

---@private
function _class:updateCategoryButtonUI(button)
    if self.preCategButton then
        self.preCategButton:textColor(_Color.Gray)
            :bgColor(_Color.LightGray)--ok
            :setTextFontStyle(FontStyle.NORMAL)
    end
    button:textColor(_Color.White):setTextFontStyle(FontStyle.BOLD)
          :bgColor(Color(253, 74, 63))--ok
    self.preCategButton = button
end
function _class:gotoDetailView()
    require("lua_pods.LuaPageManager.LuaPageManager")
    LuaPageManager:gotoPage("ideaMassEntryFile", Map(), AnimType.BottomToTop, 1)

end
return _class
